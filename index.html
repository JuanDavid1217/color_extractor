<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Extractor</title>
    <style>
        html {
            box-sizing: border-box;
        }

        *,
        *::before,
        *::after {
            box-sizing: inherit;
        }

        body {
            font-family: sans-serif;
            text-align: center;
            padding: 1rem;
        }

        canvas {
            border: 1px solid #ccc;
            display: block;
            margin: 1rem auto;
            max-width: 100%;
        }

        #colors-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 6px;
        }

        .color-box {
            width: 24px;
            height: 24px;
            border: 1px solid #999;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <h2>Extracts all colors from a image.</h2>
    <input type="file" id="image-file" accept="image/*">
    <canvas id="canvas"></canvas>
    <div id="colors-container"></div>
    <!-- <input type="color" id="pixel-color"> -->

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const imageFile = document.getElementById('image-file');
        const colorsContainer = document.getElementById('colors-container');
        /* const pixelColor = document.getElementById('pixel-color'); */

        imageFile.onchange = function() {
            let file = imageFile.files[0];
            let reader = new FileReader();
            reader.readAsDataURL(file);

            reader.onload = function() {
                let img = new Image();
                img.src = reader.result;

                img.onload = function() {
                    
                    const maxWidth = 600;
                    const maxHeight = 400;

                    let scale = Math.min(maxWidth / img.width, maxHeight / img.height);
                    let newWidth = img.width * scale;
                    let newHeight = img.height * scale;

                    canvas.width = newWidth;
                    canvas.height = newHeight;

                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);

                    const uniqueColors = getAllColors();
                    showColors(uniqueColors);
                };
            };
        };

        // THIS FUNCTION IS TO SHOW THE PIXEL SELECTED COLOR
        /* canvas.addEventListener("click", function(e){
            let rect = canvas.getBoundingClientRect();
            let x = e.clientX-rect.left;
            let y = e.clientY-rect.top;
            let data = ctx.getImageData(x, y, 1, 1).data;
            let rgb = [data[0], data[1], data[2]];
            pixelColor.value = rgbToHex(data[0], data[1], data[2]);
            pixelColor.click();
        }); */

        function calcDistance(color1, color2) {
            const redDifference = color1[0] - color2[0];
            const greenDifference = color1[1] - color2[1];
            const blueDifference = color1[2] - color2[2];
            const distance = Math.sqrt((redDifference ** 2) + (greenDifference ** 2) + (blueDifference ** 2));
            return distance;
        }

        function manhattanDistance(c1, c2) {
            return Math.abs(c1[0] - c2[0]) +
                Math.abs(c1[1] - c2[1]) +
                Math.abs(c1[2] - c2[2]);
        }

        function sumColor(color,  newColor) {
            return [color[0] + newColor[0], color[1] + newColor[1], color[2] + newColor[2]];
        }

        function avgColor(color, len) {
            
            const avgRed = Math.round(color[0] / len);
            const avgGreen = Math.round(color[1] / len);
            const avgBlue = Math.round(color[2] / len);
            return [avgRed, avgGreen, avgBlue];
            
            /*
            const avgRed = Math.round((color[0] + len[0]) / 2);
            const avgGreen = Math.round((color[1] + len[1])/ 2);
            const avgBlue = Math.round((color[2] + len[2])/ 2);
            return [avgRed, avgGreen, avgBlue];
            */
        }

        function filterColors(uniqueColors, newColor, threshold = 56) {
            let isANewColor = true;
            for (let i=0;  i<uniqueColors.length; i++) {
                const distance = calcDistance(uniqueColors[i]["avg"], newColor);
                if (distance < threshold) {
                    uniqueColors[i]["sum"] = sumColor(uniqueColors[i]["sum"], newColor);
                    uniqueColors[i]["total"] = uniqueColors[i]["total"] + 1;
                    uniqueColors[i]["avg"] = avgColor(uniqueColors[i]["sum"], uniqueColors[i]["total"]);
                    //uniqueColors[i]["avg"] = avgColor(uniqueColors[i]["avg"], newColor);
                    isANewColor = false
                    break;
                }
            }

            if (isANewColor) {
                uniqueColors.push({"avg": newColor, "sum": newColor, "total": 1});
                //uniqueColors.push({"avg": newColor, "total": 1});
            }

            return uniqueColors;
        }

        function getAllColors() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            const colors = new Set();
            let uniqueColors = [];

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const a = data[i + 3];

                if (a === 0) continue;

                uniqueColors = filterColors(uniqueColors, [r, g, b]);    
            }
            
            uniqueColors.sort((a, b) => 
                b["total"]-a["total"]
            )

            for(const uniqueColor of uniqueColors) {
                const hex = rgbToHex(uniqueColor["avg"][0], uniqueColor["avg"][1], uniqueColor["avg"][2])
                colors.add(hex);
            }
            return Array.from(colors);
        }

        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b)
                .toString(16)
                .slice(1)
                .toUpperCase();
        }

        function showColors(colors) {
            colorsContainer.innerHTML = "";
            colors.forEach(color => {
                const div = document.createElement("div");
                div.className = "color-box";
                div.style.backgroundColor = color;
                div.title = color;
                div.onclick = () => alert(`Color: ${color}`);
                colorsContainer.appendChild(div);
            });
        }
    </script>

</body>
</html>
